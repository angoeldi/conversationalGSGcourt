<svg width="1200" height="720" viewBox="0 0 1200 720" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Engine flow: decisions to effects">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#2f2a22" />
    </marker>
    <style>
      .title { font: 600 22px "Segoe UI", system-ui, sans-serif; fill: #2f2a22; }
      .label { font: 600 14px "Segoe UI", system-ui, sans-serif; fill: #2f2a22; }
      .small { font: 12px "Segoe UI", system-ui, sans-serif; fill: #5b5146; }
      .box { stroke: #2f2a22; stroke-width: 1.5; rx: 12; }
      .ui { fill: #f1efe9; }
      .llm { fill: #f7efe2; }
      .db { fill: #eef3f7; }
      .engine { fill: #f3efe9; }
      .arrow { stroke: #2f2a22; stroke-width: 1.6; fill: none; marker-end: url(#arrow); }
      .dashed { stroke-dasharray: 6 6; }
      .legend-box { fill: #ffffff; stroke: #c8b8a0; stroke-width: 1; rx: 10; }
      .badge { font: 700 12px "Segoe UI", system-ui, sans-serif; fill: #ffffff; }
    </style>
  </defs>

  <rect x="0" y="0" width="1200" height="720" fill="#fbfaf7" />
  <text x="600" y="48" text-anchor="middle" class="title">How a decision becomes effects on the nation</text>

  <!-- Step 1 -->
  <rect class="box ui" x="60" y="110" width="190" height="90" />
  <rect x="76" y="126" width="24" height="24" rx="6" fill="#2f2a22" />
  <text x="88" y="143" text-anchor="middle" class="badge">1</text>
  <text x="155" y="150" text-anchor="middle" class="label">Player decision</text>
  <text x="155" y="172" text-anchor="middle" class="small">(final / no‑objection)</text>

  <!-- Step 2 -->
  <rect class="box llm" x="280" y="110" width="200" height="90" />
  <rect x="296" y="126" width="24" height="24" rx="6" fill="#2f2a22" />
  <text x="308" y="143" text-anchor="middle" class="badge">2</text>
  <text x="380" y="150" text-anchor="middle" class="label">Decision parse</text>
  <text x="380" y="172" text-anchor="middle" class="small">LLM → structured JSON</text>

  <!-- Step 3 -->
  <rect class="box db" x="520" y="110" width="200" height="90" />
  <rect x="536" y="126" width="24" height="24" rx="6" fill="#2f2a22" />
  <text x="548" y="143" text-anchor="middle" class="badge">3</text>
  <text x="620" y="150" text-anchor="middle" class="label">Queue actions</text>
  <text x="620" y="172" text-anchor="middle" class="small">decision_queue + actions</text>

  <!-- Step 4 -->
  <rect class="box engine" x="760" y="110" width="220" height="90" />
  <rect x="776" y="126" width="24" height="24" rx="6" fill="#2f2a22" />
  <text x="788" y="143" text-anchor="middle" class="badge">4</text>
  <text x="870" y="150" text-anchor="middle" class="label">Engine apply</text>
  <text x="870" y="172" text-anchor="middle" class="small">applySingleAction → effects</text>

  <!-- Step 5 -->
  <rect class="box db" x="760" y="240" width="220" height="90" />
  <rect x="776" y="256" width="24" height="24" rx="6" fill="#2f2a22" />
  <text x="788" y="273" text-anchor="middle" class="badge">5</text>
  <text x="870" y="280" text-anchor="middle" class="label">Persist results</text>
  <text x="870" y="302" text-anchor="middle" class="small">action_effects + snapshots</text>

  <!-- Step 6 -->
  <rect class="box" x="60" y="320" width="220" height="90" />
  <rect x="76" y="336" width="24" height="24" rx="6" fill="#2f2a22" />
  <text x="88" y="353" text-anchor="middle" class="badge">6</text>
  <text x="170" y="360" text-anchor="middle" class="label">Next turn tasks</text>
  <text x="170" y="382" text-anchor="middle" class="small">generateTasksForTurn</text>

  <!-- Connectors -->
  <path class="arrow" d="M250 155 H280" />
  <path class="arrow" d="M480 155 H520" />
  <path class="arrow" d="M720 155 H760" />
  <path class="arrow" d="M870 200 V240" />
  <path class="arrow" d="M870 330 V440 H170 V320" />

  <!-- Optional auto-decide -->
  <rect class="box" x="340" y="320" width="220" height="90" />
  <text x="450" y="360" text-anchor="middle" class="label">Auto‑decide open</text>
  <text x="450" y="382" text-anchor="middle" class="small">Optional end‑of‑week</text>
  <path class="arrow dashed" d="M450 320 V200" />
  <text x="462" y="232" class="small">optional</text>

  <!-- Court chat note -->
  <rect class="box llm" x="600" y="320" width="260" height="90" />
  <text x="730" y="358" text-anchor="middle" class="label">Court chat</text>
  <text x="730" y="380" text-anchor="middle" class="small">LLM advice only</text>
  <text x="730" y="400" text-anchor="middle" class="small">(no state change)</text>

  <!-- Legend -->
  <rect class="legend-box" x="60" y="470" width="1080" height="190" />
  <text x="90" y="505" class="label">Legend</text>

  <rect x="90" y="525" width="18" height="18" class="box ui" />
  <text x="120" y="538" class="small">UI / player input</text>

  <rect x="320" y="525" width="18" height="18" class="box llm" />
  <text x="350" y="538" class="small">LLM processing</text>

  <rect x="520" y="525" width="18" height="18" class="box db" />
  <text x="550" y="538" class="small">Database writes</text>

  <rect x="720" y="525" width="18" height="18" class="box engine" />
  <text x="750" y="538" class="small">Deterministic engine</text>

  <text x="90" y="585" class="small">Only Actions mutate state. LLM output is parsed into Action bundles, then applied deterministically.</text>
  <text x="90" y="610" class="small">Snapshots are saved each week; effects are logged per action for auditability.</text>
</svg>
